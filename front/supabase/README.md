# Supabase Migration Files

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€ã‚¢ã‚¤ãƒ‡ã‚¢ãƒãƒ¼ã‚±ãƒƒãƒˆã®Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ“‹ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ«å | èª¬æ˜ |
|-----------|------|
| `20250127000001_initial_extensions_and_enums.sql` | æ‹¡å¼µæ©Ÿèƒ½ã¨ENUMå‹ã®åˆæœŸè¨­å®š |
| `20250127000002_core_tables.sql` | ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆprofiles, ideas, comments, user_detailsï¼‰ |
| `20250127000003_business_tables.sql` | ãƒ“ã‚¸ãƒã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆidea_versions, purchases, adsç­‰ï¼‰ |
| `20250127000004_cmt_functions.sql` | CMTç•ªå·ç”Ÿæˆæ©Ÿèƒ½ã¨é–¢é€£ãƒˆãƒªã‚¬ãƒ¼ |
| `20250127000005_rls_policies.sql` | Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼ |
| `20250127000006_search_indexes.sql` | æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨æ¤œç´¢é–¢æ•° |
| `20250127000007_sample_data.sql` | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆé–‹ç™ºç”¨ï¼‰ |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®ä½¿ç”¨

```bash
# Supabase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã¾ã ã®å ´åˆï¼‰
npm install -g supabase

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–
supabase init

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’èµ·å‹•
supabase start

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
supabase db reset
```

### 2. æœ¬ç•ªç’°å¢ƒã§ã®ä½¿ç”¨

```bash
# ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªãƒ³ã‚¯
supabase link --project-ref YOUR_PROJECT_REF

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ¬ç•ªç’°å¢ƒã«ãƒ—ãƒƒã‚·ãƒ¥
supabase db push
```

### 3. æ‰‹å‹•å®Ÿè¡Œï¼ˆSupabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰

1. [Supabase Dashboard](https://app.supabase.com) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ â†’ **SQL Editor**
3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †ç•ªã«å®Ÿè¡Œï¼š
   - 001 â†’ 002 â†’ 003 â†’ 004 â†’ 005 â†’ 006 â†’ 007

## ğŸ“Š ä½œæˆã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«

### ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«
- **`profiles`** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
- **`user_details`** - ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°æƒ…å ±ï¼ˆæ”¯æ‰•ã„ãƒ»å€‹äººæƒ…å ±ï¼‰
- **`ideas`** - å½“åˆã‚¢ã‚¤ãƒ‡ã‚¢
- **`comments`** - ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆLINEé¢¨ï¼‰
- **`cmt_counters`** - CMTç•ªå·ç®¡ç†

### ãƒ“ã‚¸ãƒã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«
- **`idea_versions`** - æœ€çµ‚ã‚¢ã‚¤ãƒ‡ã‚¢ï¼ˆXç‰ˆ/Yç‰ˆï¼‰
- **`purchases`** - è³¼å…¥å±¥æ­´
- **`ads`** - åºƒå‘Šç®¡ç†
- **`ad_metrics`** - åºƒå‘Šè¨ˆæ¸¬
- **`pages`** - CMSï¼ˆè¦ç´„/æŠ€è¡“/ä¼šç¤¾æƒ…å ±ï¼‰
- **`audit_logs`** - ç›£æŸ»ãƒ­ã‚°

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

### Row Level Security (RLS)
å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSãŒæœ‰åŠ¹åŒ–ã•ã‚Œã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã¾ã™ï¼š

- **å…¬é–‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**: ideasï¼ˆpublishedï¼‰ã€idea_versionsï¼ˆXç‰ˆï¼‰ã€pagesï¼ˆpublishedï¼‰
- **åˆ¶é™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**: idea_versionsï¼ˆYç‰ˆï¼‰ã¯è³¼å…¥è€…ã®ã¿
- **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ**: purchasesï¼ˆè³¼å…¥è€…ã®ã¿ï¼‰ã€user_detailsï¼ˆæœ¬äººã®ã¿ï¼‰
- **ç®¡ç†è€…å°‚ç”¨**: adsã€ad_metricsã€audit_logs

## ğŸ” æ¤œç´¢æ©Ÿèƒ½

### åˆ©ç”¨å¯èƒ½ãªæ¤œç´¢é–¢æ•°

```sql
-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆé¡ä¼¼åº¦ä»˜ãï¼‰
SELECT * FROM public.search_ideas_by_keyword('AI æ•™è‚²');

-- CMTç•ªå·ã«ã‚ˆã‚‹å®Œå…¨ä¸€è‡´æ¤œç´¢
SELECT * FROM public.search_idea_by_cmt_no('CMT-250127-0001');

-- ã‚¢ã‚¤ãƒ‡ã‚¢ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œç´¢ï¼ˆXç‰ˆã®ã¿ï¼‰
SELECT * FROM public.search_idea_versions_by_keyword('æ©Ÿæ¢°å­¦ç¿’');

-- äººæ°—ã®ã‚¢ã‚¤ãƒ‡ã‚¢å–å¾—ï¼ˆè³¼å…¥æ•°é †ï¼‰
SELECT * FROM public.get_popular_ideas(10);
```

## âš ï¸ æ³¨æ„äº‹é …

### å®Ÿè¡Œå‰ã®ç¢ºèª
1. **å®Ÿè¡Œé †åº**: å¿…ãš001ã‹ã‚‰007ã®é †ç•ªã§å®Ÿè¡Œ
2. **æœ¬ç•ªç’°å¢ƒ**: `007_sample_data.sql`ã¯é–‹ç™ºç’°å¢ƒã®ã¿ã§å®Ÿè¡Œ
3. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: æœ¬ç•ªç’°å¢ƒã§ã®å®Ÿè¡Œå‰ã¯å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—

### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
```bash
# .env.local ã«ä»¥ä¸‹ã‚’è¨­å®š
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼

**æ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼**
```
ERROR: extension "pg_trgm" is not available
```
â†’ Supabaseã§è‡ªå‹•çš„ã«åˆ©ç”¨å¯èƒ½ãªæ‹¡å¼µæ©Ÿèƒ½ã§ã™ã€‚

**RLSã‚¨ãƒ©ãƒ¼**
```
ERROR: permission denied for table
```
â†’ Service Role Keyã‚’ä½¿ç”¨ã—ã¦SQL Editorã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

**å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚¨ãƒ©ãƒ¼**
```
ERROR: insert or update on table violates foreign key constraint
```
â†’ å‚ç…§å…ˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## ğŸ“– é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [DBè¨­è¨ˆæ›¸](../documents/DBè¨­è¨ˆæ›¸.md)
- [Supabaseãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs)
- [PostgreSQLå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.postgresql.org/docs/)
