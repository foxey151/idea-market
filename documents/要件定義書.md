# 要件定義（SRS）

## 1. 背景・目的

不特定多数のユーザーがアイデアを投稿し、別ユーザーのコメントでブラッシュアップ、投稿者が概要版（X）/詳細版（Y）を作成。概要版（X）は公開、詳細版（Y）は企業等が購入できるマーケットを構築する。関連する検索結果に連動した広告を表示する。

「アイデア」の対象は技術案・新規/既存事業案・デザイン・レシピ・キャッチコピー等を含み、誹謗中傷を除き投稿可。購入により企業は時間短縮・新発見等のメリットを得る世界観。 **アイデアマーケット**

## 2. スコープ

**画面群：**
- 表紙
- 登録
- 当初アイデア+コメント（LINE風）
- 最終アイデア入力
- 検索
- 規約/会社情報/技術情報
- 広告
- 管理画面（全画面へのジャンプ・加筆削除・ログDL）

**基盤刷新：**
WixからAWS等へ移行。URLは維持し、既存投稿データは移行。サーバ容量は将来拡張。

## 3. 用語

- **A**：当初アイデア投稿者
- **B**：コメント投稿者
- **K**：購入主体（企業）
- **X**：概要版（公開）
- **Y**：詳細版（有償）

**コメント番号（例：CMT-yymmdd0001）：** ピンポイント検索キーとして利用。

## 4. 役割と権限

### ゲスト
- 閲覧・検索・広告閲覧

### 会員（A/B）
- 登録後、当初アイデア投稿・コメント・最終アイデア入力（X/Y生成）

### 企業会員（K）
- 検索・X閲覧・Y購入・購入履歴閲覧

### 管理者
- 全画面への編集権限
- CMS的に規約/会社情報/広告を追記・更新
- ログDL（CSV/TXT）
- 各種審査/凍結

## 5. 主要ユースケース

### 会員登録
規約同意必須 → メール認証/SSOオプション

### 当初アイデア投稿（A）
タイトル・概要・タグ・添付

### コメント投稿（B）
LINE風タイムラインでブラッシュアップ

### 最終アイデア作成（A）
X（公開）/Y（非公開・有償）を投稿

### 検索（ゲスト/K）
- **当初+コメント：** CMT番号またはキーワードでヒット → 当該スレッド表示
- **最終成果品（X/Y）：** 概要内検索で一覧 → Xは閲覧、Yは購入導線

### 広告
検索キーワード等に連動し企業バナーを表示。専用広告画面も設置。

### 購入（K）
決済 → Yの閲覧/ダウンロード可

### 管理
全画面にジャンプ編集、ログDL（CSV/TXT）、広告/規約/会社情報の更新

## 6. 画面要件（ルーティング例）

| パス | 概要 |
|------|------|
| `/` | 表紙：ヒーロー・CTA（登録/投稿/検索/規約/広告） |
| `/signup` | 登録：規約同意チェック必須 → ユーザー作成 |
| `/ideas/new` | 当初入力：投稿フォーム＋LINE風コメント欄（同画面） |
| `/ideas/final/new` | 最終入力：X/Y作成フォーム（Yは有償フラグ） |
| `/search` | 検索：CMT番号・キーワード・フィルタ（X/Y/当初/コメント） |
| `/legal` | 規約・会社情報・技術情報（CMS更新可） |
| `/ads` | 広告：バナー管理/一覧、ターゲティング設定 |
| `/admin` | 管理：全画面へのジャンプ、加筆削除、ログDL |
| `/purchase/:id` | 購入フロー |
| `/my/purchases` | 購入済み一覧 |

## 7. 機能要件（抜粋）

- **FR-01:** 登録時、規約同意無しでは登録不可
- **FR-02:** コメント番号の自動採番（CMT-YYMMDD-####）
- **FR-03:** 検索：
  - 番号一致は完全一致で単一スレッド表示
  - キーワードはアイデア概要（当初/最終）を対象に全文検索
  - 並び替え（関連/新着/いいね/購入数）
- **FR-04:** 広告：検索語・カテゴリに応じ検索結果/関連画面にバナー表示
- **FR-05:** 管理：各画面編集・CSV/TXTログDL
- **FR-06:** 既存データ移行：Wixからのエクスポート → 正規化 → 取り込み。URLは据え置き

## 8. 非機能要件

- **NFR-可用性：** 99.9%/月、RPO≤24h、RTO≤4h
- **NFR-性能：** 検索P95 ≤ 800ms、一覧ページ初回描画 ≤ 2.5s（LCP）
- **NFR-セキュリティ：** OWASP ASVS L2相当、WAF、CSP、2FA（管理者必須）
- **NFR-拡張性：** ストレージ水平拡張、広告/決済/検索のモジュール化
- **NFR-運用：** 監視（APM/ログ/メトリクス）、自動バックアップ、IaC

## 9. 外部IF

- **決済：** Stripe（カード/請求書）
- **メール：** SES/SendGrid
- **検索：** Elasticsearch/OpenSearch（コストダウン要件に応じGoogle Programmable Search検討可）
- **広告：** 社内簡易広告モジュール（将来 Google Ads Manager連携可）

## 10. マイグレーション要件（Wix→AWS）

- **URL維持：** Route 53 / ALB / ACMで既存ドメイン継続
- **既存投稿データ移行：** Wixからのエクスポート（CSV/JSON/RSS/スクレイピング可） → クリーニング → DBインポート
- **SEO対策：** 301リダイレクト、サイトマップ再生成、構造化データ整備、Search Console再検証
- **容量拡張：** S3＋バージョニング、ライフサイクルで低頻度/アーカイブへ

## 11. 受け入れ条件（例）

- [ ] CMT番号検索で該当スレッドのみが即時表示される
- [ ] Xは誰でも閲覧可能、Yは購入後のみ閲覧可
- [ ] 検索結果に関連広告が表示される
- [ ] 管理画面から規約/会社情報/広告を編集し、ログをCSV/TXT出力できる



# 基本設計（ベース）

## 1. 全体アーキテクチャ（AWS例）

- **フロント/SSR：** Next.js（App Router） on AWS Amplify Hosting or Vercel（ドメインはRoute53で管理）
- **API：** AWS Lambda + API Gateway（Node.js）／将来はECS Fargateへ拡張可
- **DB：** Amazon RDS (PostgreSQL)
- **検索：** Amazon OpenSearch（もしくはPG + pg_trgmで簡易全文検索→段階的拡張）
- **ストレージ：** S3（画像/添付）+ CloudFront（CDN）
- **認証：** Cognito（Email+Password / OIDC）、管理者は2FA必須
- **IaC：** CDK / Terraform
- **監視：** CloudWatch / X-Ray、APM（Datadog等）

## 2. 主要ドメインモデル（論理）

```sql
-- ユーザー管理
users (
  id UUID PRIMARY KEY,
  role ENUM(guest, member, company, admin),
  email VARCHAR UNIQUE,
  terms_agreed_at TIMESTAMP,
  ...
)

-- アイデア管理
ideas (
  id UUID PRIMARY KEY,
  author_id UUID REFERENCES users(id),
  status ENUM(draft, published),
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  cmt_no VARCHAR(20) UNIQUE -- CMT-YYMMDD-####
)

-- アイデアバージョン（X/Y版）
idea_versions (
  id UUID PRIMARY KEY,
  idea_id UUID REFERENCES ideas(id),
  type CHAR(1) CHECK (type IN ('X', 'Y')),
  title TEXT,
  summary TEXT,
  body TEXT,
  price INTEGER,
  is_public BOOLEAN, -- X=true/Y=false
  ...
)

-- コメント（LINE風表示用）
comments (
  id UUID PRIMARY KEY,
  idea_id UUID REFERENCES ideas(id),
  author_id UUID REFERENCES users(id),
  body TEXT,
  created_at TIMESTAMP,
  line_order INTEGER
)

-- 購入管理
purchases (
  id UUID PRIMARY KEY,
  buyer_id UUID REFERENCES users(id),
  idea_version_id UUID REFERENCES idea_versions(id), -- Y版のみ
  amount INTEGER,
  paid_at TIMESTAMP,
  invoice_url TEXT,
  ...
)

-- 広告管理
ads (
  id UUID PRIMARY KEY,
  title TEXT,
  image_url TEXT,
  link_url TEXT,
  target_keywords TEXT[],
  active_period DATERANGE,
  ...
)

-- 検索インデックス
search_index (
  doc_id UUID,
  doc_type ENUM(idea_x, idea_initial, thread),
  vector TSVECTOR,
  text TEXT
)

-- CMS化ページ
pages (
  slug TEXT PRIMARY KEY, -- legal/company/tech
  content JSONB,
  updated_by UUID REFERENCES users(id)
)

-- 監査ログ（CSV/TXT出力対象）
audit_logs (
  id UUID PRIMARY KEY,
  actor_id UUID REFERENCES users(id),
  action TEXT,
  entity TEXT,
  payload JSONB,
  created_at TIMESTAMP
)

-- ファイル管理
files (
  id UUID PRIMARY KEY,
  s3_key TEXT,
  mime TEXT,
  size INTEGER,
  owner_id UUID REFERENCES users(id),
  linked_entity TEXT
)
```

コメント番号・検索・CMS的編集・ログDLなど、原仕様の要点を網羅。

## 3. ルーティング/画面コンポーネント

- **表紙：** Hero、CTA、最新X一覧、広告スロット
- **登録：** フォーム（規約同意チェックがdisabled解除条件）
- **当初+コメント：** 二欄レイアウト（左：当初概要/メタ、右：LINE風コメント）
- **最終入力：** X/Yタブ、Yは価格・利用許諾・返金規約明示
- **検索：** CMT番号入力、キーワード、対象（当初/最終/スレッド）フィルタ、広告スロット
- **規約/会社/技術：** 編集可能なCMSブロック
- **広告：** 一覧・新規作成・ターゲティング設定・プレビュー
- **管理：** クイックランチャー（各画面へジャンプ）、編集/削除、ログDL（CSV/TXT）

## 4. 検索設計

- **番号検索：** cmt_no 完全一致 → 当該スレッド（当初+コメント）を直接表示
- **キーワード検索：** idea_versions (X) と ideas.summary を対象、形態素解析（ja）＋BM25、将来Embedding検索拡張
- **並び替え：** 関連・最新・人気（いいね/購入）
- **広告連動：** クエリトークン化（例："新規事業 AND 医療"）→ ads.target_keywords一致で挿入

## 5. 決済設計

- **Stripe Checkout：** 成功Webhookでpurchases作成 → Yへのアクセス権付与
- **電子領収書、請求書：** 企業向け
- **不正対策：** 3Dセキュア、レート制限

## 6. 認証・認可

- **会員：** Email+PW、メール検証
- **企業：** ドメイン認証/請求書払い申請
- **管理：** Role=admin、2FA、IP制限オプション

## 7. ログ/監視

- **監査ログ：** 作成/更新/削除/ログイン/支払 → 管理画面からCSV/TXTエクスポート
- **アプリ/インフラメトリクス：** APM、エラートラッキング

## 8. バッチ/ジョブ

- CMT番号採番（当日連番）
- OpenSearch再インデックス
- 期限付き広告の自動無効化

## 9. SEO/コンテンツ

- **URL移行：** 旧→新URLの301、サイトマップ、robots、構造化データ（Breadcrumb/Article/Product）
- **最適化：** OGP/Twitter Cards、LCP最適化（SSR＋CDN）

## 10. テーブル定義（例・抜粋）

| テーブル | 主要カラム |
|----------|------------|
| `ideas` | id (UUID), author_id, cmt_no (unique), summary (text), status, created_at |
| `idea_versions` | id, idea_id (FK), type ('X'\|'Y'), title, summary, body (rich), price (int), is_public (bool) |
| `comments` | id, idea_id (FK), author_id, body, created_at, line_order (int) |
| `ads` | id, title, image_url, link_url, target_keywords (tsvector/text[]), active_from, active_to, priority (int) |
| `audit_logs` | id, actor_id, action, entity, entity_id, payload (jsonb), created_at |

## 11. API設計（REST例・抜粋）

```http
POST /api/signup              # 規約同意チェック
POST /api/ideas               # 当初作成→cmt_no採番
POST /api/ideas/:id/comments  # コメント投稿
POST /api/ideas/:id/final     # X/Y作成
GET  /api/search?cmt_no=... | q=...&type=x|initial|thread
POST /api/purchase/:versionId # Stripeセッション作成
GET  /api/admin/logs?format=csv|txt # DL
```

## 12. セキュリティ

- **入力検証：** WAF、CSP、CSRF対策
- **アップロード：** MIME/サイズ検査、S3署名URL
- **暗号化：** PII暗号化（KMS）、権限チェック層

## 13. 開発段階（目安）

- **P0（MVP）：** 登録/規約同意、当初+コメント、最終X/Y、検索（番号/キーワード）、購入、広告表示（静的）、管理ログDL
- **P1：** 広告ターゲティング、CMS化、OpenSearch、請求書払い
- **P2：** SSO、埋め込み検索、レコメンド





# アイデアマーケット｜詳細設計 & 実装チェックリスト（P0〜P2）

> **前提：** Wix→AWS移行。前段の要件定義・基本設計を踏まえ、P0（MVP）→P1→P2の実装を安全に完了させるための**詳細設計（LLD）と実装チェックリスト（DoD/Runbook）**を統合。

---

# 1. 詳細設計（LLD）

## 1.1 認証・認可（Cognito）

- **ユーザープール構成：** members（一般/企業/管理）
- **カスタム属性：** role（member/company/admin）, termsAgreedAt（ISO8601）
- **パスワードポリシー：** 長さ≥12、英大小/数字/記号1種以上
- **2FA：** adminはTOTP必須
- **IdP：** Email/PW（P0）、OIDC/Google（P1）
- **セッション：** アクセストークン15m/リフレッシュ30d、aud検証
- **管理画面IP制限：** ALB + WAF

## 1.2 API（API Gateway + Lambda / Node.js）

### 命名
REST + リソース指向

### 主要エンドポイント（抜粋）

```http
POST /signup                          # 規約同意必須
POST /ideas                          # 当初作成 → cmt_no採番
POST /ideas/{id}/comments            # コメント投稿
POST /ideas/{id}/final               # X/Y作成
GET  /search?cmt_no=... | q=...&type=x|initial|thread&sort=...
POST /purchase/{versionId}           # Stripe Checkout
POST /webhooks/stripe                # 支払成功→purchases作成
GET  /admin/logs?format=csv|txt      # ログDL
```

### 非機能
- **レート制限：** X-Client-Id単位 60rpm（サインイン済100rpm）
- **冪等化：** 書込APIはIdempotency-Key必須
- **バリデーション：** Zod/TypeBox + AJV、400/422の切り分け

## 1.3 DB（Amazon RDS / PostgreSQL）

### 基本設定
- **文字コード：** UTF-8
- **タイムゾーン：** UTC（アプリ側JST表示）

### テーブル（主なDDLイメージ）

```sql
-- 基本テーブル
users(id uuid pk, email unique, role, terms_agreed_at timestamptz, created_at, updated_at)
ideas(id uuid pk, author_id fk, cmt_no varchar(20) unique, summary text, status, created_at, updated_at)
idea_versions(id uuid pk, idea_id fk, type char(1) check in('X','Y'), title text, summary text, body text, price int, is_public boolean, created_at)
comments(id uuid pk, idea_id fk, author_id fk, body text, line_order int, created_at)
purchases(id uuid pk, buyer_id fk, idea_version_id fk, amount int, paid_at, invoice_url text, status)
ads(id uuid pk, title text, image_url text, link_url text, target_keywords text[], active_from, active_to, priority int)
pages(slug text pk, content jsonb, updated_by fk, updated_at)
audit_logs(id uuid pk, actor_id fk, action text, entity text, entity_id uuid, payload jsonb, created_at)
files(id uuid pk, s3_key text, mime text, size int, owner_id fk, created_at)
```

### インデックス
- `ideas(cmt_no)`, `idea_versions(type, is_public)`, `comments(idea_id, line_order)`
- `purchases(buyer_id, paid_at)`, `ads(active_from, active_to)`

### トリガ
- **ideas：** INSERT時にcmt_no割当（CMT-YYMMDD-####）
- **audit_logs：** アプリ層から必ず記録

## 1.4 検索（Amazon OpenSearch / 代替：pg_trgm）

### P0: PostgreSQL + pg_trgm
- **対象：** idea_versions.title/summary、ideas.summary
- **日本語：** 標準では分かち無し → 3-gram

### P1: OpenSearch（kuromoji）
- **インデックス：** ideas_x（Xのみ公開）、threads（当初+コメント）
- **アナライザ：** kuromoji_tokenizer + 小文字化 + 句読点除去
- **同義語：** 新規事業,新規ビジネス; 生成AI,ジェネレーティブAI
- **スコア：** BM25 + boost(title)、並び替えrelevance|new|popular

## 1.5 広告（社内簡易モジュール）

- **マッチング：** 検索クエリをトークン化 → ads.target_keywordsに&&一致
- **表示位置：** 検索結果リストの1位/5位/末尾（A/B可）
- **フリークエンシーキャップ：** user_id + ad_idで24hあたり3回まで（Cookie/LocalStorage併用）
- **監査：** クリック/表示をaudit_logsとは別にad_metricsへ

## 1.6 決済（Stripe）

- **商品：** Y版はidea_version.id単位
- **税：** 消費税10%（税込価格表示）
- **Webhook：** checkout.session.completed, payment_intent.succeeded
- **失敗時：** 購入権付与しない／メール再決済導線
- **返金：** 管理画面から全額返金（部分返金はP1）

## 1.7 ファイルアップロード（S3）

- **方式：** 署名URL（PUT）
- **制限：** サイズ≤20MB、MIMEホワイトリスト（pdf, png, jpg, webp, txt, md）
- **ウイルススキャン：** P1でLambda（ClamAV）
- **公開権：** Y添付はprivate（署名URLのみ）

## 1.8 管理（/admin）

- **クイックランチャー：** 各画面へ遷移
- **編集：** 規約/会社/技術（pages）のWYSIWYG
- **ログDL：** audit_logsをCSV/TXTで期間絞込DL
- **権限制御：** RBAC（admin専用）、IP制限

## 1.9 SEO/計測

- **301マップ：** Wix旧 → 新（一覧表に従う）
- **構造化データ：** Article（X）, Product（Y）, BreadcrumbList
- **OGP/Twitterカード：** X詳細で生成
- **イベント：** search_performed, ad_impression, ad_click, purchase_succeeded

## 1.10 監視・運用

### SLO
- **稼働率：** 99.9%
- **検索：** P95≤800ms
- **購入成功率：** ≥99.5%

### アラート
- 5xx比率、Stripe Webhook失敗、DB接続数、CPU/Memory、Queue滞留

### 週次運用
- バックアップ検証、ログ閾値レビュー、セキュリティ更新

---



# 2. 実装チェックリスト（Definition of Done）

## 2.1 フロントエンド（Next.js）

### ルーティング & 画面
- [ ] App Router で `/` `/signup` `/ideas/new` `/ideas/{id}` `/ideas/final/new` `/search` `/purchase/{id}` `/admin` を実装（直リンク/更新/戻るで崩れない）
- [ ] 未ログイン時の保護ルートは `/signup` へ誘導（意図しない情報露出なし）
- [ ] 404/500/メンテの専用ページ実装

### データ取得 & 状態管理
- [ ] SSR/ISR を適切に使い分け（一覧＝ISR、詳細＝SSR/CSR）
- [ ] React Query/SWR でフェッチ、リトライ/キャッシュ/キャンセル対応
- [ ] ローディング/スケルトン/エンプティステートを用意

### フォーム/入力
- [ ] Zod + React Hook Form で同期/非同期バリデーション
- [ ] 冪等送信（多重クリック防止、送信中は disabled）
- [ ] ファイルアップロード：S3 署名URL、進捗/失敗リトライ

### UI/UX
- [ ] LINE 風コメント：仮想リスト化（1,000件でもスクロール滑らか）
- [ ] X/Y タブ：Y は価格・利用許諾・返金規約の明示（必須チェック）
- [ ] 検索 UI：CMT 番号/キーワード/フィルタ/ソート、0件時の案内
- [ ] 広告スロット：1位/5位/末尾の3枠、枠高プレースホルダで CLS 0 に近づける

### アクセシビリティ/国際化
- [ ] A11y: ランドマーク/ラベル/フォーカスリング/コントラスト比 ≥ 4.5:1
- [ ] 全主要導線がキーボードのみで完了（Tab 順序も自然）
- [ ] i18n 構造（将来の多言語に備えキー化、デフォルトは ja）

### エラー処理/観測性
- [ ] Error Boundary と再試行 UI
- [ ] 重要操作は計測イベント送出（重複防止・デバウンス）

### パフォーマンス
- [ ] 画像は next/image、遅延読み込み
- [ ] LCP ≤ 2.5s / CLS ≤ 0.1 / TBT ≤ 200ms を本番データで達成
- [ ] バンドル解析（不要依存削減、コード分割）

### テスト
- [ ] 単体（UI/ロジック）、E2E（主要ユーザーフロー）

## 2.2 バックエンド（API/DB）

### API 仕様
- [ ] OpenAPI（/swagger）自動生成と配布
- [ ] REST リソース命名、HTTP ステータス/エラーコード準拠

### バリデーション/冪等/整合性
- [ ] すべての書込 API で Idempotency-Key を受理・検証
- [ ] 入力はスキーマバリデーション（400/422 を使い分け）
- [ ] 重要更新は DB トランザクションで一貫性を担保

### 認証/認可
- [ ] Cognito JWT 検証（aud/exp）、RBAC（member/company/admin）
- [ ] リソース所有権チェック（他人のリソースにアクセス不可）

### ドメインロジック
- [ ] cmt_no 採番は日別連番 + 同時競合防止（DB ロック）
- [ ] 検索（P0=pg_trgm）／P1=OpenSearch 同期（CDC バッチ）
- [ ] 監査ログ（作成/更新/削除/権限/決済）はすべて記録

### 決済/ファイル
- [ ] Stripe Checkout + Webhook（冪等性・再試行 DLQ）
- [ ] 支払成功で purchases 作成→権限付与、失敗時は付与なし
- [ ] S3 署名 URL（拡張子/MIME/サイズ検査、Y は private）

### DB/パフォーマンス
- [ ] 主要クエリに適切な Index（実行計画確認、N+1 排除）
- [ ] タイムゾーンは DB=UTC、表示のみ JST
- [ ] マイグレーションはロールフォワード/ロールバック両対応

### 観測性
- [ ] 構造化ログ（相関 ID）、APM トレース、メトリクス導出

## 2.3 インフラ（AWS）

### 環境/ネットワーク
- [ ] dev/stg/prd 分離、各環境でドメイン/証明書/鍵分離
- [ ] Route53/ACM/CloudFront/ALB 構成（www/apex 両対応）
- [ ] WAF（SQLi/XSS/RateLimit）有効化、管理画面は IP 制限

### デプロイ/運用
- [ ] IaC（CDK/Terraform）で全構成再現可能
- [ ] CI/CD（プレビュー→stg→prd、手動承認・ロールバック手順）
- [ ] RDS 自動バックアップ/復元検証、S3 バージョニング/ライフサイクル
- [ ] CloudWatch ログ保持/メトリクス/アラーム（通知先テスト済）
- [ ] コスト可視化（リソースタグ、月次コストレポート）

## 2.4 セキュリティ

- [ ] OWASP ASVS L2 を満たすチェックリストでレビュー完了
- [ ] ヘッダ：CSP/Strict-Transport-Security/X-Frame-Options/Referrer-Policy 他
- [ ] セッション/トークン：SameSite=Strict/HttpOnly/Secure、CSRF トークン
- [ ] 認証：管理者 2FA 必須、パスワードポリシー≥12 文字
- [ ] Rate Limit/ロック：総当たり耐性、指数バックオフ
- [ ] 依存脆弱性：High 以上 0 件で出荷、SCA レポート保存
- [ ] ログに PII を残さない（必要箇所はマスキング）
- [ ] 鍵/秘密情報は Secrets Manager、ローテーション方針
- [ ] 年 1 回の脆弱性診断/ペンテスト（P1 以降）

## 2.5 QA/受入

- [ ] 単体/結合/契約/スナップショット/E2E が CI で緑
- [ ] クロスブラウザ：Chrome/Edge/Safari/Firefox の最新 −1 を確認
- [ ] モバイル：iOS/Android 最新でレイアウト崩れなし
- [ ] 負荷試験：同時 100 ユーザで検索 P95 ≤ 800ms、購入成功率 ≥ 99.5%
- [ ] アクセシビリティ：主要導線をキーボードのみで完了
- [ ] 受入テスト項目表（全ケース）合格、UAT サインオフ取得

## 2.6 SEO/計測

- [ ] 301 リダイレクト表どおりに遷移（全主要 URL を網羅テスト）
- [ ] サイトマップ/robots 配信、Search Console 登録/検証
- [ ] 構造化データ（Article/Product/Breadcrumb）検証合格
- [ ] Lighthouse（本番データ）で Performance/SEO ≥ 90
- [ ] 計測：イベント命名スキーマ遵守、ダッシュボードで search/purchase/ad_click を可視化
- [ ] Cookie/同意管理（PP/オプトアウト導線）

## 2.7 データ移行

- [ ] データインベントリ & マッピング（Wix → 新 DB）確定
- [ ] 変換スクリプト実装（クリーニング/正規化/ID 採番）
- [ ] ドライラン：stg で全量インポート→件数/サンプル照合
- [ ] 画像/添付の S3 への移行 & リンク再書換
- [ ] 301/410 リスト生成→自動テストでカバレッジ確認
- [ ] Go 本番移行：所要時間/ロールバック手順/連絡体制を明文化
- [ ] 移行後検証：総件数一致、ランダム 100 件の目視、検索/購入の動作確認

---


### バックエンド（API/DB）追加実装項目

- [ ] スキーマDDL/マイグレーション適用
- [ ] cmt_no採番（同日連番の競合防止、Tx内ロック）
- [ ] 検索（pg_trgm）実装、余白テスト（0件時のグレースフル表示）
- [ ] Stripe Checkout + Webhook冪等性
- [ ] S3署名URL（MIME/サイズ検査）
- [ ] audit_logs全書込系で記録
- [ ] RBAC/リソース所有権チェック
- [ ] 入力バリデーション/エラー整形

### 2.3 インフラ（AWS）追加実装項目

- [ ] Route53/ACM/ALB/CloudFront設定（www/apex）
- [ ] WAF（SQLi/XSS/RateLimit）
- [ ] Secrets（SSM Parameter / Secrets Manager）
- [ ] CloudWatch Log保持/メトリクス/アラーム
- [ ] バックアップ（RDS自動/S3バージョニング）
- [ ] IaC（CDK/Terraform）で再現可能

### 2.4 セキュリティ追加実装項目

- [ ] CSP（default-src 'self' + 必要最小）
- [ ] CSRF対策（SameSite=Lax/Strict + トークン）
- [ ] CORS（オリジン制限）
- [ ] Rate Limit + 失敗時指数バックオフ
- [ ] ログにPIIを残さない/マスキング
- [ ] 依存パッケージ脆弱性ゼロ（High以上）

### 2.5 QA/受入追加実装項目

- [ ] 受入項目表に沿った手動テスト完了
- [ ] E2E（サインアップ→投稿→コメント→最終X/Y→検索→購入）
- [ ] 負荷：同時100ユーザで検索P95≤800ms
- [ ] アクセシビリティ：キーボードのみで主要導線完了

### 2.6 SEO/計測追加実装項目

- [ ] 301リダイレクト表どおりの遷移
- [ ] サイトマップ/robots更新
- [ ] 構造化データの検証（Rich Results）
- [ ] 計測イベントのダッシュボード可視化

### 2.7 データ移行追加実装項目

- [ ] 移行マッピング表確定
- [ ] ドライラン（ステージング）→差分/不整合のFix
- [ ] 画像/添付のS3移行
- [ ] 旧URL→新URLの301/410適用
- [ ] 移行後検証（件数/ランダム抽出目視）

---



# 3. リリース前チェックリスト（Go/No-Go）

- [ ] 重大バグ0件 / High脆弱性0件
- [ ] SLO/性能目標達成
- [ ] 決済本番キー差し替え/Webhook疎通
- [ ] 管理者2FA/権限最小化
- [ ] 監視/アラーム有効・通知先確認
- [ ] 返金・障害・復旧Runbookレビュー
- [ ] 法務ページ最終レビュー（特商法/規約/PP）



---

# 4. PRレビュー標準（エンジニア向け）

- [ ] 小さなPR（<400行）/ 1目的
- [ ] テスト/型の追加
- [ ] セキュアコーディング（入力検証/エスケープ）
- [ ] ログ/監査の過不足
- [ ] パフォーマンス（N+1防止/Index活用）



---

# 5. 脅威モデリング（要点）

| 脅威カテゴリ | 対策 |
|-------------|------|
| **スプーフィング** | セッション固定化→SameSite/HttpOnly/Secure、TOTP |
| **改ざん** | 署名URL期限/スコープ、Stripe Webhook秘密 |
| **情報漏洩** | S3バケットprivate、最小権限IAM |
| **DoS** | WAF + レート制限 |
| **リプレイ** | 冪等キー、nonce/state |



---

# 6. 受入テスト項目表（抜粋テンプレ）

| ID | 機能 | 前提 | 手順 | 期待結果 |
|----|------|------|------|----------|
| A-01 | サインアップ | 規約ページ公開 | 規約同意→登録 | メール検証通過→ログイン可能 |
| I-05 | 当初投稿 | ログイン済 | タイトル/概要入力→保存 | cmt_no採番・詳細へ遷移 |
| C-02 | コメント | 当初スレッド表示 | コメント入力→送信 | 時系列に表示・自動スクロール |
| F-03 | 最終X/Y | 当初投稿済 | X/Y作成→公開 | Xは公開、Yは非公開（購入導線） |
| S-07 | 検索 | 既存データあり | CMT番号で検索 | 対応スレッドのみ表示 |
| P-04 | 決済 | Stripe本番 | Y購入→決済成功 | 購入済み一覧に追加・Y閲覧可能 |
| AD-03 | 広告 | 広告登録済 | 検索（一致語） | リスト1位枠に広告表示 |
| L-01 | ログDL | Adminログイン | CSV出力 | 指定期間CSV取得 |


---

# 7. 運用Runbook（要点）

## 障害対応
- **一次対応：** 5xx増加→APMトレース→直近デプロイロールバック
- **Webhook失敗：** DLQ確認→再試行→Stripeダッシュボード整合
- **返金対応：** 管理画面→Stripe→purchases.status=refunded

## 定期運用
- **月次：** バックアップ復元試験、OpenSearch再インデックス検証



---

# 8. フェーズ別スコープ

## P0（MVP）
サインアップ、当初+コメント、最終X/Y、検索（pg_trgm）、購入、広告（静的）、管理ログDL、移行


## P1
OpenSearch、広告ターゲティング/レポート、返金部分、ウイルススキャン、請求書払い

## P2
SSO、レコメンド、外部広告連携、コンテンツレコメンド



---

## 補足

該当セクションはこのままJira/Notionにコピペ運用可能。

追加のCSVテンプレ（301表、移行マッピング、受入テスト、イベント定義）が必要なら依頼ください。